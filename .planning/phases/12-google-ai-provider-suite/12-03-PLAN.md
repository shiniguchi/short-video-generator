---
phase: 12-google-ai-provider-suite
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/video_generator/google_veo.py
  - app/services/video_generator/generator.py
  - app/services/video_generator/__init__.py
autonomous: true

must_haves:
  truths:
    - "GoogleVeoProvider generates video clips via Veo 3.1 API"
    - "Veo provider clamps duration to max 8 seconds with warning log"
    - "Veo provider supports both text-to-video and image-to-video modes"
    - "Video generator factory includes 'veo' as provider option alongside existing kling/minimax/svd"
    - "Provider falls back to mock when GOOGLE_API_KEY is missing or USE_MOCK_DATA=true"
  artifacts:
    - path: "app/services/video_generator/google_veo.py"
      provides: "Veo 3.1 video provider with native audio support"
      contains: "class GoogleVeoProvider"
    - path: "app/services/video_generator/generator.py"
      provides: "Updated factory with veo provider option"
      contains: "GoogleVeoProvider"
    - path: "app/services/video_generator/__init__.py"
      provides: "Updated exports including GoogleVeoProvider"
      contains: "GoogleVeoProvider"
  key_links:
    - from: "app/services/video_generator/generator.py"
      to: "app/services/video_generator/google_veo.py"
      via: "Factory instantiation when video_provider_type='veo'"
      pattern: "GoogleVeoProvider"
    - from: "app/services/video_generator/google_veo.py"
      to: "google.generativeai"
      via: "SDK import for Veo API calls"
      pattern: "import google.generativeai"
---

<objective>
Create Google Veo 3.1 Video Provider extending the existing VideoProvider abstraction.

Purpose: Add Veo 3.1 as a video generation option alongside Kling and Minimax. Veo generates video with built-in voice/audio, eliminating separate TTS for talking-head content. Critical 8-second-per-clip limit must be enforced. Supports text-to-video and image-to-video modes.

Output: New `google_veo.py` provider file, updated factory and package exports.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-google-ai-provider-suite/12-RESEARCH.md
@app/services/video_generator/base.py
@app/services/video_generator/mock.py
@app/services/video_generator/fal_kling.py
@app/services/video_generator/generator.py
@app/services/video_generator/__init__.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google Veo 3.1 video provider</name>
  <files>
    app/services/video_generator/google_veo.py
  </files>
  <action>
Create `app/services/video_generator/google_veo.py` following the EXACT pattern of `fal_kling.py`:

**GoogleVeoProvider(VideoProvider):**
- Constructor takes `google_api_key: str` and `output_dir: str`. Calls `genai.configure(api_key=google_api_key)`. Creates clips_dir. Has lazy `_mock_provider` property (same as FalKlingProvider pattern).

- `generate_clip(prompt, duration_seconds, width=720, height=1280) -> str`:
  - Check `settings.use_mock_data` or empty `google_api_key` -- fall back to mock (same pattern as FalKlingProvider)
  - **CRITICAL: Clamp duration** -- `duration_seconds = min(duration_seconds, 8)`. If original was >8, log warning: `"Veo 3.1 max 8s/clip: clamped {original}s to {duration_seconds}s"`
  - Determine aspect_ratio: `"9:16"` if height > width else `"16:9"`
  - Determine resolution: `"1080p"` if width >= 1080 else `"720p"`
  - Create model: `genai.GenerativeModel("veo-3.1-generate-preview")`
  - Call API: `operation = model.generate_videos(prompt=prompt, config={"aspect_ratio": aspect_ratio, "resolution": resolution, "duration_seconds": str(duration_seconds)})`
  - Poll until done: `while not operation.done: time.sleep(10); operation = operation.refresh()`
  - Save video: `video = operation.response.generated_videos[0]; output_path = os.path.join(self.clips_dir, f"veo_{uuid4().hex[:8]}.mp4"); video.video.save(output_path)`
  - Log elapsed time and return output_path
  - Wrap entire real API section in try/except -- on failure, log error and fall back to mock (same as FalKlingProvider)

- Optional `generate_clip_from_image(prompt, image_path, duration_seconds, width, height) -> str`:
  - Same as generate_clip but loads image with PIL and passes to `model.generate_videos(prompt=prompt, image=image, config=...)` for image-to-video mode
  - This method is NOT part of VideoProvider ABC (it's an extension). Document it as Veo-specific capability for Phase 13 usage.

- `supports_resolution(width, height) -> bool`:
  - Supported resolutions: `[(720, 1280), (1080, 1920), (1280, 720), (1920, 1080)]` (9:16 and 16:9 in HD and Full HD)
  - Return `(width, height) in SUPPORTED_RESOLUTIONS`

Use imports: `import google.generativeai as genai`, `from tenacity import retry, stop_after_attempt, wait_exponential`, `import time`, `import os`, `from uuid import uuid4`, `from PIL import Image`
  </action>
  <verify>
Run:
```python
python -c "
from app.services.video_generator.google_veo import GoogleVeoProvider
provider = GoogleVeoProvider(google_api_key='', output_dir='output')
print(f'Provider created: {type(provider).__name__}')
print(f'Supports 720x1280: {provider.supports_resolution(720, 1280)}')
print(f'Supports 1080x1920: {provider.supports_resolution(1080, 1920)}')
print(f'Supports 500x500: {provider.supports_resolution(500, 500)}')
# Test mock fallback (no API key = mock)
clip_path = provider.generate_clip('test', 5)
print(f'Mock clip generated: {clip_path}')
print('GoogleVeoProvider works')
"
```
  </verify>
  <done>GoogleVeoProvider extends VideoProvider ABC with Veo 3.1 API support. Duration clamped to 8s max. Supports text-to-video and image-to-video. Falls back to mock when API key missing.</done>
</task>

<task type="auto">
  <name>Task 2: Update video generator factory and package exports</name>
  <files>
    app/services/video_generator/generator.py
    app/services/video_generator/__init__.py
  </files>
  <action>
**generator.py** - Add Veo to factory:
- Add import: `from app.services.video_generator.google_veo import GoogleVeoProvider`
- In `get_video_generator()`, add `elif provider_type == "veo":` case BEFORE the `elif provider_type == "svd":` block:
  ```python
  elif provider_type == "veo":
      google_api_key = getattr(settings, "google_api_key", "")
      provider = GoogleVeoProvider(google_api_key=google_api_key, output_dir=output_dir)
  ```
- Update docstring to include "veo" in the list: `"mock"` / `"svd"` / `"kling"` / `"minimax"` / `"veo"`

**__init__.py** - Add exports:
- Add `from app.services.video_generator.google_veo import GoogleVeoProvider`
- Add `"GoogleVeoProvider"` to `__all__` list
  </action>
  <verify>
Run:
```python
python -c "
from app.services.video_generator import GoogleVeoProvider, get_video_generator
print(f'GoogleVeoProvider imported: {GoogleVeoProvider}')

# Default factory should still return mock
gen = get_video_generator()
print(f'Default provider: {type(gen.provider).__name__}')
print('Video generator factory updated successfully')
"
```
  </verify>
  <done>Video generator factory supports VIDEO_PROVIDER_TYPE=veo. GoogleVeoProvider is exported from package. Factory creates GoogleVeoProvider with google_api_key from config when type is "veo".</done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.video_generator import GoogleVeoProvider; print('OK')"` succeeds
2. GoogleVeoProvider clamps duration to 8 seconds max
3. Factory creates GoogleVeoProvider when `VIDEO_PROVIDER_TYPE=veo`
4. Default factory still returns MockVideoProvider
5. GoogleVeoProvider falls back to mock on API errors
</verification>

<success_criteria>
- GoogleVeoProvider is a valid VideoProvider implementation
- Duration clamping to 8 seconds is enforced with logging
- Image-to-video mode available via generate_clip_from_image() extension method
- Factory function includes "veo" option
- Mock fallback works when USE_MOCK_DATA=true or API key empty
</success_criteria>

<output>
After completion, create `.planning/phases/12-google-ai-provider-suite/12-03-SUMMARY.md`
</output>
