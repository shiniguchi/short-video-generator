---
phase: 12-google-ai-provider-suite
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/image_provider/base.py
  - app/services/image_provider/mock.py
  - app/services/image_provider/google_imagen.py
  - app/services/image_provider/__init__.py
autonomous: true

must_haves:
  truths:
    - "ImageProvider abstraction generates images from text prompts"
    - "GoogleImagenProvider uses google-generativeai SDK for image generation"
    - "MockImageProvider generates placeholder images without API calls"
    - "Factory function selects provider based on IMAGE_PROVIDER_TYPE setting"
    - "Provider supports optional reference images for style guidance"
  artifacts:
    - path: "app/services/image_provider/base.py"
      provides: "ImageProvider ABC with generate_image() and supports_resolution()"
      contains: "class ImageProvider"
    - path: "app/services/image_provider/google_imagen.py"
      provides: "Imagen implementation using google-generativeai SDK"
      contains: "class GoogleImagenProvider"
    - path: "app/services/image_provider/mock.py"
      provides: "Mock image provider for testing"
      contains: "class MockImageProvider"
    - path: "app/services/image_provider/__init__.py"
      provides: "Factory function get_image_provider()"
      contains: "def get_image_provider"
  key_links:
    - from: "app/services/image_provider/__init__.py"
      to: "app/config.py"
      via: "get_settings() for provider selection"
      pattern: "get_settings\\(\\)"
    - from: "app/services/image_provider/google_imagen.py"
      to: "google.generativeai"
      via: "SDK import for API calls"
      pattern: "import google.generativeai"
---

<objective>
Create Image Provider abstraction layer with Imagen implementation.

Purpose: Add a new ImageProvider subsystem (similar to existing VideoProvider and TTSProvider) for text-to-image generation. GoogleImagenProvider generates images via Imagen 4 API. This enables Phase 13's hero image generation and B-Roll product shots.

Output: New `app/services/image_provider/` package with ABC, mock, Imagen providers, and factory function.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-google-ai-provider-suite/12-RESEARCH.md
@app/config.py
@app/services/video_generator/base.py
@app/services/video_generator/mock.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Image Provider ABC, Mock, and Imagen implementations</name>
  <files>
    app/services/image_provider/base.py
    app/services/image_provider/mock.py
    app/services/image_provider/google_imagen.py
  </files>
  <action>
Create `app/services/image_provider/` directory with three files:

**base.py** - ImageProvider ABC:
- `generate_image(prompt: str, width: int = 1024, height: int = 1024, num_images: int = 1, reference_images: Optional[List[str]] = None) -> List[str]` - Generate images from text prompt, returns list of file paths
- `supports_resolution(width: int, height: int) -> bool` - Check if resolution is supported
- Use `from typing import List, Optional` (Python 3.9)
- Follow exact ABC pattern from `app/services/video_generator/base.py`

**mock.py** - MockImageProvider:
- Constructor takes `output_dir: str`. Creates `self.images_dir = os.path.join(output_dir, "images")` and ensures it exists.
- `generate_image()`: Generate solid-color placeholder PNG images using Pillow (`from PIL import Image as PILImage`). Pick color from prompt hash (same pattern as `MockVideoProvider._pick_color()`). Create `PILImage.new("RGB", (width, height), color)`, save to `self.images_dir/mock_{uuid4().hex[:8]}.png`. Return list of paths (one per num_images).
- `supports_resolution()`: Always returns True (mock supports any resolution).
- Follow pattern from `app/services/video_generator/mock.py`

**google_imagen.py** - GoogleImagenProvider:
- Constructor takes `api_key: str` and `output_dir: str`. Calls `genai.configure(api_key=api_key)`. Creates images_dir. Has lazy `_mock_provider` property (same as other providers).
- Import: `from google.generativeai import ImageGenerationModel, configure` (the deprecated google-generativeai SDK 0.8.x exports `ImageGenerationModel` directly -- confirmed in research Example 2, line 509)
- `generate_image()`:
  - Use `ImageGenerationModel("imagen-4.0-generate-001")` (note model name from research: `imagen-4.0-generate-001`, NOT `imagen-4.0-generate-preview`)
  - Derive aspect_ratio from width/height: `"9:16"` if height > width, `"16:9"` if width > height, `"1:1"` if equal
  - Call `model.generate_images(prompt=prompt, number_of_images=num_images, aspect_ratio=aspect_ratio)`
  - Handle reference_images: if provided, load each with `PIL.Image.open(path)` and pass as `reference_images=[img1, img2, ...]` to generate_images
  - Save generated images: iterate `response.images`, call `img.save(output_path)` with unique filenames `mock_{uuid4().hex[:8]}.png` in images_dir
  - Wrap API call in tenacity retry: `@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=2, min=4, max=30))`
  - Fallback: if API call fails, log error and fall back to MockImageProvider via `_mock_provider`
- `supports_resolution()`: Check against Imagen supported sizes. Return True for common sizes (512-2048 range in both dimensions).
  </action>
  <verify>
Run:
```python
python -c "
from app.services.image_provider.base import ImageProvider
from app.services.image_provider.mock import MockImageProvider

mock = MockImageProvider(output_dir='output')
paths = mock.generate_image('test product photo', width=512, height=512)
print(f'Generated {len(paths)} image(s): {paths}')
assert len(paths) == 1
assert paths[0].endswith('.png')
print('Mock image provider works')
"
```
  </verify>
  <done>ImageProvider ABC exists with generate_image() and supports_resolution(). MockImageProvider generates placeholder PNG images with Pillow. GoogleImagenProvider uses google-generativeai SDK with retry logic.</done>
</task>

<task type="auto">
  <name>Task 2: Create Image Provider factory and package exports</name>
  <files>
    app/services/image_provider/__init__.py
  </files>
  <action>
**__init__.py** - Factory function + exports:
- `get_image_provider() -> ImageProvider` factory function:
  - Gets settings via `get_settings()`
  - Reads `settings.image_provider_type` (default "mock")
  - If `"imagen"`: check `settings.google_api_key` -- if empty or `settings.use_mock_data` is True, log warning and return `MockImageProvider(output_dir=settings.output_dir)`. Otherwise return `GoogleImagenProvider(api_key=settings.google_api_key, output_dir=settings.output_dir)`
  - Else (including "mock"): return `MockImageProvider(output_dir=settings.output_dir)`
  - Follow exact same factory pattern as `app/services/video_generator/generator.py::get_video_generator()`
- Export: `ImageProvider`, `MockImageProvider`, `GoogleImagenProvider`, `get_image_provider`

NOTE: This plan does NOT modify `app/config.py` -- the `image_provider_type` setting is added by Plan 01 (which adds all three config fields to avoid file conflicts in parallel execution).
  </action>
  <verify>
Run:
```python
python -c "
from app.services.image_provider import get_image_provider, ImageProvider, MockImageProvider
provider = get_image_provider()
print(f'Provider type: {type(provider).__name__}')
assert isinstance(provider, MockImageProvider), 'Should be mock by default'
print('Factory returns MockImageProvider by default - OK')
"
```
  </verify>
  <done>Factory function get_image_provider() returns correct provider based on IMAGE_PROVIDER_TYPE setting. Package exports all provider classes and factory function.</done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.image_provider import get_image_provider; p = get_image_provider(); print(type(p).__name__)"` prints "MockImageProvider"
2. ImageProvider ABC has `generate_image` and `supports_resolution` abstract methods
3. MockImageProvider generates valid PNG files using Pillow
4. GoogleImagenProvider imports without error
5. Factory correctly falls back to mock when USE_MOCK_DATA=true
</verification>

<success_criteria>
- ImageProvider abstraction is importable and functional with mock provider
- MockImageProvider generates solid-color PNG placeholders
- GoogleImagenProvider uses google-generativeai SDK for Imagen API
- Factory function correctly selects provider based on config
- All Python 3.9 typing patterns used
</success_criteria>

<output>
After completion, create `.planning/phases/12-google-ai-provider-suite/12-02-SUMMARY.md`
</output>
