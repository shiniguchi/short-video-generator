---
phase: 03-content-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/config_reader.py
  - app/schemas.py
  - app/models.py
  - app/config.py
  - alembic/versions/003_content_generation_schema.py
autonomous: true

must_haves:
  truths:
    - "System reads theme/product configuration from local config file"
    - "Production Plan schema includes all required fields: video_prompt, scenes, text_overlays, voiceover_script, hashtags, title, description, duration_target, aspect_ratio, hook_text, cta_text"
    - "Theme config data is available as validated Pydantic model"
  artifacts:
    - path: "app/services/config_reader.py"
      provides: "Theme config reader from sample-data.yml with ThemeConfig model"
      exports: ["read_theme_config", "ThemeConfig"]
    - path: "app/schemas.py"
      provides: "ProductionPlan Pydantic schemas for Claude structured outputs"
      contains: "class VideoProductionPlanCreate"
    - path: "alembic/versions/003_content_generation_schema.py"
      provides: "Database migration adding content generation fields"
  key_links:
    - from: "app/services/config_reader.py"
      to: "config/sample-data.yml"
      via: "YAML file loading with pydantic validation"
      pattern: "yaml\\.safe_load"
    - from: "app/schemas.py"
      to: "app/models.py"
      via: "Pydantic schemas match SQLAlchemy model columns"
      pattern: "class VideoProductionPlanCreate"
---

<objective>
Build the config reader service and production plan data schemas for Phase 3 content generation.

Purpose: Establishes the data foundation that the script generator (Plan 02) and content pipeline (Plan 03) build on. Theme config provides the input; production plan schemas define the output shape.

Output: Working config reader that loads theme data from sample-data.yml, complete Pydantic schemas for VideoProductionPlan, and Alembic migration for Script model field additions.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-generation/03-RESEARCH.md
@app/config.py
@app/schemas.py
@app/models.py
@config/sample-data.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme config reader service with local YAML fallback</name>
  <files>app/services/config_reader.py, app/config.py, config/sample-data.yml</files>
  <action>
Create `app/services/config_reader.py` with:

1. **ThemeConfig Pydantic model** with fields matching sample-data.yml config section:
   - `theme: str` (e.g., "Product Demo")
   - `target_platform: str` (e.g., "tiktok")
   - `video_duration_seconds: int` (e.g., 20)
   - `style: str` (e.g., "cinematic")
   - `auto_post: bool` (default False)

2. **ContentReference Pydantic model** with fields:
   - `ref_id: str`
   - `type: str` (e.g., "product")
   - `title: str`
   - `description: str`
   - `media_url: Optional[str]`
   - `talking_points: List[str]`

3. **read_theme_config(config_path: Optional[str] = None) -> ThemeConfig** function:
   - If config_path not provided, use `settings.local_config_path` (defaults to "config/sample-data.yml")
   - Load YAML with `yaml.safe_load()`
   - Extract `config` key and validate with ThemeConfig
   - Return validated ThemeConfig

4. **read_content_references(config_path: Optional[str] = None) -> List[ContentReference]** function:
   - Load same YAML, extract `content_references` key
   - Validate each entry as ContentReference
   - Return list

5. Update `config/sample-data.yml` to include richer sample data:
   - Add `product_name` and `tagline` fields to config section (needed by script generator prompt)
   - Add `target_audience` and `tone` fields to config section
   - Keep existing fields, just extend
   - Add a second content reference entry for testing variety

6. Add to `app/config.py`:
   - `openai_api_key: str = ""` (for TTS provider in Plan 02)
   - `video_provider_type: str = "mock"` (mock/svd/veo)
   - `tts_provider_type: str = "mock"` (mock/openai/elevenlabs)
   - `output_dir: str = "output"` (base directory for generated files)

Use `from typing import List, Optional` (Python 3.9 compatible). Do NOT use `list[str]` syntax.
  </action>
  <verify>
Run in Python:
```python
from app.services.config_reader import read_theme_config, read_content_references
config = read_theme_config()
assert config.theme is not None
assert config.video_duration_seconds > 0
refs = read_content_references()
assert len(refs) >= 1
assert refs[0].talking_points is not None
print(f"Theme: {config.theme}, Duration: {config.video_duration_seconds}s")
print(f"References: {len(refs)}")
```
  </verify>
  <done>read_theme_config() returns validated ThemeConfig from sample-data.yml, read_content_references() returns list of ContentReference models, config.py has new settings for video/TTS provider types and output directory</done>
</task>

<task type="auto">
  <name>Task 2: Production Plan Pydantic schemas and Alembic migration</name>
  <files>app/schemas.py, app/models.py, alembic/versions/003_content_generation_schema.py</files>
  <action>
Add to `app/schemas.py` the following Pydantic schemas for the Video Production Plan:

1. **SceneSchema** (used in prompt chain step 3):
   - `scene_number: int`
   - `duration_seconds: int` (2-4 range)
   - `visual_prompt: str` (text prompt for video generation)
   - `transition: str` (fade/cut/dissolve)

2. **TextOverlaySchema** (used in prompt chain step 5):
   - `text: str`
   - `timestamp_start: float` (seconds)
   - `timestamp_end: float` (seconds)
   - `position: str` (top/center/bottom)
   - `style: str` (bold/normal/highlight)

3. **VideoProductionPlanCreate** (the complete Claude output, used as tool-use schema):
   - `video_prompt: str` (master visual prompt)
   - `duration_target: int` (15-30 seconds)
   - `aspect_ratio: str` (always "9:16")
   - `scenes: List[SceneSchema]`
   - `voiceover_script: str`
   - `hook_text: str` (first 3 seconds hook)
   - `cta_text: str` (call-to-action)
   - `text_overlays: List[TextOverlaySchema]`
   - `hashtags: List[str]`
   - `title: str`
   - `description: str`

4. **VideoProductionPlanResponse** (for API responses):
   - Same fields as Create plus `id: int`, `created_at: Optional[datetime]`
   - `class Config: from_attributes = True`

5. Update `app/models.py` Script model:
   - Add `duration_target = Column(Integer)` (15-30 seconds)
   - Add `aspect_ratio = Column(String(10), default="9:16")`
   - Add `hook_text = Column(String(500))`
   - Add `cta_text = Column(String(500))`
   - Add `theme_config = Column(JSON)` (snapshot of theme config used)
   - Add `trend_report_id = Column(Integer, ForeignKey("trend_reports.id"), nullable=True)`

6. Create Alembic migration `003_content_generation_schema.py`:
   - Add the new columns to `scripts` table
   - Add `production_plans` table if needed for normalized storage (optional, Script table may be sufficient)
   - Follow existing migration pattern from 001/002

Use `from typing import List, Optional` throughout. All schemas must be compatible with Claude tool-use pattern (will be passed through `_add_additional_properties_false()` from trend_analyzer.py).
  </action>
  <verify>
```bash
# Run migration
cd /Users/naokitsk/Documents/short-video-generator && python -m alembic upgrade head

# Verify schemas
python -c "
from app.schemas import VideoProductionPlanCreate, SceneSchema, TextOverlaySchema
schema = VideoProductionPlanCreate.model_json_schema()
assert 'video_prompt' in schema['properties']
assert 'scenes' in schema['properties']
assert 'voiceover_script' in schema['properties']
assert 'hashtags' in schema['properties']
print('Schema fields:', list(schema['properties'].keys()))
print('Schema valid for Claude tool-use')
"
```
  </verify>
  <done>VideoProductionPlanCreate schema has all 11 required fields (video_prompt, duration_target, aspect_ratio, scenes, voiceover_script, hook_text, cta_text, text_overlays, hashtags, title, description). Script model has new columns. Migration runs without errors.</done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.config_reader import read_theme_config; c = read_theme_config(); print(c.theme)"` prints theme name
2. `python -c "from app.schemas import VideoProductionPlanCreate; print(VideoProductionPlanCreate.model_json_schema())"` shows all fields
3. `python -m alembic upgrade head` completes without errors
4. `python -c "from app.models import Script; print([c.name for c in Script.__table__.columns])"` shows new columns
</verification>

<success_criteria>
- ThemeConfig loaded from sample-data.yml with all config fields validated
- ContentReference list loaded with talking_points
- VideoProductionPlanCreate schema includes all 11 required fields per SCRIPT-03
- Script model has duration_target, aspect_ratio, hook_text, cta_text, theme_config, trend_report_id
- Alembic migration 003 runs cleanly
- All imports Python 3.9 compatible (typing.List not list[str])
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-generation/03-01-SUMMARY.md`
</output>
