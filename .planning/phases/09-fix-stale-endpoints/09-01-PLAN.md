---
phase: 09-fix-stale-endpoints
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/routes.py
  - app/services/video_compositor/compositor.py
autonomous: true

must_haves:
  truths:
    - "POST /generate-content creates a Job record and passes job_id to generate_content_task"
    - "POST /compose-video creates a Job record and passes job_id as first argument to compose_video_task"
    - "Manual content generation flow completes without TypeError"
    - "VideoCompositor default output_dir is output/review not output/final"
    - "output/final/ directory no longer exists in the project"
  artifacts:
    - path: "app/api/routes.py"
      provides: "Fixed POST /generate-content and POST /compose-video endpoints"
      contains: "job_id"
    - path: "app/services/video_compositor/compositor.py"
      provides: "Corrected default output_dir"
      contains: "output/review"
  key_links:
    - from: "app/api/routes.py (trigger_content_generation)"
      to: "app/tasks.py (generate_content_task)"
      via: "generate_content_task.delay(job_id, theme_config_path)"
      pattern: "generate_content_task\\.delay\\(job_id"
    - from: "app/api/routes.py (trigger_video_composition)"
      to: "app/tasks.py (compose_video_task)"
      via: "compose_video_task.delay(job_id, script_id, video_path, audio_path, cost_data)"
      pattern: "compose_video_task\\.delay\\(job_id"
---

<objective>
Fix the two manual per-stage API endpoints (POST /generate-content and POST /compose-video) that broke when Phase 7 added job_id as the first parameter to their underlying Celery tasks. Also clean up the stale output/final default in VideoCompositor and remove the unused output/final/ directory.

Purpose: Restore INFRA-04 (API completeness) so all 19 endpoints are functional, including manual step-by-step debugging flows alongside the orchestrated pipeline.
Output: Working manual endpoints with on-demand Job creation, aligned VideoCompositor default, no stale legacy artifacts.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-fix-stale-endpoints/09-RESEARCH.md
@app/api/routes.py
@app/tasks.py
@app/models.py
@app/database.py
@app/services/video_compositor/compositor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix POST /generate-content and POST /compose-video endpoints</name>
  <files>app/api/routes.py</files>
  <action>
Fix two endpoint signatures in app/api/routes.py to pass job_id to their Celery tasks:

**1. POST /generate-content (lines 172-177):**

Replace the current `trigger_content_generation()` endpoint with one that:
- Accepts `job_id: Optional[int] = None` as a query parameter
- Accepts `theme_config_path: Optional[str] = None` as a query parameter
- Injects `session: AsyncSession = Depends(get_session)` for DB access
- When `job_id is None`, creates a new Job record with:
  - `status="pending"`
  - `stage="content_generation"`
  - `theme="manual"`
  - `extra_data={"completed_stages": []}`
- Awaits `session.commit()` then `session.refresh(job)` before using `job.id`
- Calls `generate_content_task.delay(job_id, theme_config_path)` — job_id as first arg
- Returns dict with `task_id`, `job_id`, `status`, `description`
- Uses lazy import: `from app.models import Job` inside the function body (follows established pattern from POST /generate endpoint at line 514)

**2. POST /compose-video (lines 244-253):**

Replace the current `trigger_video_composition()` endpoint with one that:
- Keeps existing required params: `script_id: int`, `video_path: str`, `audio_path: str`
- Adds `job_id: Optional[int] = None` as query parameter
- Adds `cost_data: Optional[dict] = None` as query parameter (aligns with task signature)
- Injects `session: AsyncSession = Depends(get_session)` for DB access
- When `job_id is None`, creates a new Job record with:
  - `status="pending"`
  - `stage="composition"`
  - `theme="manual"`
  - `extra_data={"completed_stages": ["content_generation"]}`
- Awaits `session.commit()` then `session.refresh(job)` before using `job.id`
- Calls `compose_video_task.delay(job_id, script_id, video_path, audio_path, cost_data)` — job_id as FIRST arg (Phase 7 signature order)
- Returns dict with `task_id`, `job_id`, `status`, `description`
- Uses lazy import: `from app.models import Job` inside the function body

IMPORTANT: The `from typing import Optional` and `from app.database import get_session` imports already exist at the top of routes.py (lines 4 and 8). Do not duplicate them.

IMPORTANT: Use `Optional[int]` not `int | None` (Python 3.9 compatibility).
  </action>
  <verify>
Run the following to confirm no syntax errors and correct task invocation patterns:

```bash
cd /Users/naokitsk/Documents/short-video-generator && source venv/bin/activate && python -c "import ast; ast.parse(open('app/api/routes.py').read()); print('Syntax OK')"
```

Then grep to confirm job_id is passed as first argument to both task .delay() calls:

```bash
grep -n "generate_content_task.delay\|compose_video_task.delay" app/api/routes.py
```

Expected: Both lines should show `job_id` as the first argument.
  </verify>
  <done>
- POST /generate-content accepts optional job_id, creates Job when missing, passes job_id as first arg to generate_content_task.delay()
- POST /compose-video accepts optional job_id, creates Job when missing, passes job_id as first arg to compose_video_task.delay()
- Both endpoints return job_id in response
- No syntax errors in routes.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix VideoCompositor default and remove output/final</name>
  <files>app/services/video_compositor/compositor.py</files>
  <action>
Two changes:

**1. Fix VideoCompositor default (compositor.py line 31):**

Change the `__init__` default parameter from `output_dir: str = "output/final"` to `output_dir: str = "output/review"`. Also update the docstring on line 36 to say `output/review` instead of `output/final`. This aligns the code default with the config.py setting established in Phase 5. Note: In practice, the compositor is always instantiated with `output_dir=settings.composition_output_dir` from tasks.py (line 252), so this is a fallback/documentation alignment.

**2. Remove the empty output/final/ directory:**

```bash
rmdir output/final
```

Only `rmdir` (not `rm -rf`) — the directory should be empty. If it fails, investigate what's inside before removing.
  </action>
  <verify>
Confirm the default is updated:

```bash
grep -n "output_dir" app/services/video_compositor/compositor.py | head -5
```

Expected: Line 31 shows `output/review`, not `output/final`.

Confirm output/final is gone:

```bash
ls output/final 2>&1
```

Expected: "No such file or directory"

Confirm no remaining code references to output/final:

```bash
grep -rn "output/final" app/ --include="*.py"
```

Expected: No matches.
  </verify>
  <done>
- VideoCompositor.__init__ default is output/review
- VideoCompositor docstring says output/review
- output/final/ directory does not exist
- No Python code references output/final
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify all 5 phase success criteria:

1. **POST /generate-content passes job_id:**
   ```bash
   grep -A5 "def trigger_content_generation" app/api/routes.py | grep "job_id"
   ```

2. **POST /compose-video passes job_id:**
   ```bash
   grep -A5 "def trigger_video_composition" app/api/routes.py | grep "job_id"
   ```

3. **No TypeError from missing args:**
   ```bash
   python -c "import ast; ast.parse(open('app/api/routes.py').read()); print('OK')"
   ```

4. **output/final removed:**
   ```bash
   test ! -d output/final && echo "PASS: output/final removed"
   ```

5. **All 19 endpoints exist (spot check):**
   ```bash
   grep -c "@router\." app/api/routes.py
   ```
   Expected: 19 route decorators
</verification>

<success_criteria>
- POST /generate-content creates Job on-demand and passes job_id to generate_content_task
- POST /compose-video creates Job on-demand and passes job_id as first arg to compose_video_task
- VideoCompositor default output_dir is output/review
- output/final/ directory removed
- All routes.py endpoints parse without errors
- No Python code references output/final
</success_criteria>

<output>
After completion, create `.planning/phases/09-fix-stale-endpoints/09-01-SUMMARY.md`
</output>
