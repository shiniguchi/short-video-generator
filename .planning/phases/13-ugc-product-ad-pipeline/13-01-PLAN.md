---
phase: 13-ugc-product-ad-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/schemas.py
  - app/services/ugc_pipeline/__init__.py
  - app/services/ugc_pipeline/product_analyzer.py
  - app/services/ugc_pipeline/script_engine.py
autonomous: true

must_haves:
  truths:
    - "Product analysis returns structured ProductAnalysis with category, key_features, target_audience, ugc_style, emotional_tone"
    - "Script engine generates AdBreakdown with master_script, aroll_scenes (4-8s each), broll_shots (5s each), total_duration"
    - "Script engine adapts to any product category via prompt templates, not code branches"
    - "All schemas validate correctly with Pydantic v2"
  artifacts:
    - path: "app/schemas.py"
      provides: "ProductInput, ProductAnalysis, MasterScript, ArollScene, BrollShot, AdBreakdown schemas"
      contains: "class ProductInput"
    - path: "app/services/ugc_pipeline/product_analyzer.py"
      provides: "analyze_product() function using LLMProvider two-call pattern"
      contains: "def analyze_product"
    - path: "app/services/ugc_pipeline/script_engine.py"
      provides: "generate_ugc_script() function with category-aware prompts"
      contains: "def generate_ugc_script"
  key_links:
    - from: "app/services/ugc_pipeline/product_analyzer.py"
      to: "app/services/llm_provider"
      via: "get_llm_provider() factory"
      pattern: "from app.services.llm_provider import get_llm_provider"
    - from: "app/services/ugc_pipeline/script_engine.py"
      to: "app/services/llm_provider"
      via: "get_llm_provider() factory"
      pattern: "from app.services.llm_provider import get_llm_provider"
    - from: "app/services/ugc_pipeline/script_engine.py"
      to: "app/schemas.py"
      via: "AdBreakdown schema import"
      pattern: "from app.schemas import.*AdBreakdown"
---

<objective>
Create UGC pipeline data schemas and LLM-powered services for product analysis and script generation.

Purpose: Establishes the data contracts (Pydantic schemas) and AI-driven business logic (product analyzer + script engine) that all downstream plans depend on. These services use the existing LLMProvider abstraction to work with both Gemini and mock providers.

Output: Validated Pydantic schemas for the entire UGC pipeline, a product analyzer service that extracts category/features/audience from product info, and a script engine that generates Hook-Problem-Proof-CTA ad scripts with A-Roll/B-Roll breakdowns.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ugc-product-ad-pipeline/13-RESEARCH.md
@app/schemas.py
@app/services/llm_provider/base.py
@app/services/llm_provider/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UGC pipeline Pydantic schemas to app/schemas.py</name>
  <files>app/schemas.py</files>
  <action>
Append the following Pydantic v2 schemas to the end of app/schemas.py (after the existing JobRetryResponse class). Use `from typing import List, Optional` (already imported at top of file). Add `from pydantic import HttpUrl` to the existing pydantic import line if not already there.

**ProductInput schema:**
- product_name: str
- description: str
- product_url: Optional[str] = None (use str not HttpUrl — simpler for Form parsing)
- target_duration: int = 30 (seconds, 25-30s range)
- style_preference: Optional[str] = None (selfie-review, unboxing, tutorial, lifestyle)

**ProductAnalysis schema:**
- category: str = Field(description="Product category: cosmetics, tech, food, fashion, SaaS, etc.")
- key_features: List[str] = Field(description="3-5 standout features")
- target_audience: str = Field(description="Primary demographic and psychographic profile")
- ugc_style: str = Field(description="Best UGC style: selfie-review, unboxing, tutorial, lifestyle")
- emotional_tone: str = Field(description="Tone: excited, authentic, educational, aspirational")
- visual_keywords: List[str] = Field(description="5-8 visual keywords for image/video generation")

**MasterScript schema:**
- hook: str = Field(description="Opening line, first 3 seconds")
- problem: str = Field(description="Pain point, 3-8 seconds")
- proof: str = Field(description="Product solution with social proof, 8-20 seconds")
- cta: str = Field(description="Call-to-action, final 5-10 seconds")
- full_script: str = Field(description="Complete voiceover script combining all sections")
- total_duration: int = Field(description="Total script duration in seconds")

**ArollScene schema:**
- frame_number: int
- duration_seconds: int = Field(ge=4, le=8, description="Veo max 8s per clip")
- visual_prompt: str = Field(description="UGC creator visual + action for Veo")
- voice_direction: str = Field(description="Voice tone and delivery for Veo audio")
- script_text: str = Field(description="Actual words spoken in this scene")

**BrollShot schema:**
- shot_number: int
- image_prompt: str = Field(description="Imagen prompt for product close-up/lifestyle")
- animation_prompt: str = Field(description="Veo image-to-video motion description")
- duration_seconds: int = Field(default=5, description="Standard 5s B-roll")
- overlay_start: float = Field(description="When to start overlay in final timeline (seconds)")

**AdBreakdown schema:**
- master_script: MasterScript
- aroll_scenes: List[ArollScene]
- broll_shots: List[BrollShot]
- total_duration: int

**UGCAdResponse schema (for API response):**
- job_id: int
- task_id: str
- status: str = "queued"
- poll_url: str
- message: str

Add a section comment: `# UGC Product Ad Pipeline Schemas (Phase 13)`
  </action>
  <verify>Run `python -c "from app.schemas import ProductInput, ProductAnalysis, MasterScript, ArollScene, BrollShot, AdBreakdown, UGCAdResponse; print('All UGC schemas importable')"` from project root (with venv activated).</verify>
  <done>All 7 UGC pipeline schemas importable and validate with Pydantic v2. ArollScene.duration_seconds enforces ge=4, le=8. BrollShot.duration_seconds defaults to 5.</done>
</task>

<task type="auto">
  <name>Task 2: Create product_analyzer.py and script_engine.py services</name>
  <files>
    app/services/ugc_pipeline/__init__.py
    app/services/ugc_pipeline/product_analyzer.py
    app/services/ugc_pipeline/script_engine.py
  </files>
  <action>
Create `app/services/ugc_pipeline/` directory with three files:

**__init__.py:**
```python
"""UGC Product Ad Pipeline services."""
from app.services.ugc_pipeline.product_analyzer import analyze_product
from app.services.ugc_pipeline.script_engine import generate_ugc_script

__all__ = ["analyze_product", "generate_ugc_script"]
```

**product_analyzer.py:**
Create `analyze_product(product_name, description, image_count, style_preference=None)` function that:
1. Calls `get_llm_provider()` from `app.services.llm_provider`
2. Uses `llm.generate_structured()` with `ProductAnalysis` schema
3. Prompt: "Analyze this product for UGC ad creation" with product_name, description, image_count, and optional style_preference
4. System prompt: "You are a UGC marketing strategist analyzing products for viral ad campaigns."
5. Temperature: 0.7
6. Returns a `ProductAnalysis` instance
7. Logs the analysis result (category, ugc_style)
8. Use `from typing import Optional` for type hints (Python 3.9)

**script_engine.py:**
Create `generate_ugc_script(product_name, description, analysis, target_duration=30)` function that:
1. `analysis` parameter is a `ProductAnalysis` instance
2. Uses the two-call LLM pattern (existing pattern from script_generator.py):
   - Call 1: `llm.generate_text()` — Generate master ad script using Hook-Problem-Proof-CTA structure. Include category-specific guidance from CATEGORY_PROMPTS dict. System prompt: "You are a viral UGC ad script writer..."
   - Call 2: `llm.generate_structured()` with `AdBreakdown` schema — Break the master script into A-Roll scenes (4-8s each, Veo limit) and B-Roll shots (5s each). The prompt must include the master script text from Call 1 plus analysis context.
3. Define a CATEGORY_PROMPTS dict at module level with entries for: cosmetics, tech, food, fashion, SaaS, and a "default" fallback. Use `CATEGORY_PROMPTS.get(analysis.category.lower(), CATEGORY_PROMPTS["default"])` for lookup.
4. Returns an `AdBreakdown` instance
5. Logs scene count, shot count, and total duration
6. Use `from typing import Optional, List` for type hints (Python 3.9)

IMPORTANT: Do NOT use `list[str]` syntax — use `List[str]` from typing (Python 3.9 compat).
  </action>
  <verify>Run `python -c "from app.services.ugc_pipeline import analyze_product, generate_ugc_script; print('UGC services importable')"` from project root (with venv activated). Then test mock pipeline: `python -c "from app.services.ugc_pipeline.product_analyzer import analyze_product; result = analyze_product('Test Serum', 'A hydrating face serum', 2); print(f'Category: {result.category}, Style: {result.ugc_style}')"` — should return valid ProductAnalysis with mock defaults.</verify>
  <done>product_analyzer.py returns ProductAnalysis from LLMProvider. script_engine.py returns AdBreakdown with aroll_scenes and broll_shots using two-call pattern. Both work with MockLLMProvider (USE_MOCK_DATA=true default). CATEGORY_PROMPTS dict has 6 entries including default fallback.</done>
</task>

</tasks>

<verification>
1. All 7 UGC schemas import from app.schemas without error
2. analyze_product() returns valid ProductAnalysis via MockLLMProvider
3. generate_ugc_script() returns valid AdBreakdown via MockLLMProvider
4. No `list[str]` syntax (Python 3.9 compat)
5. No hardcoded category logic (only prompt templates)
</verification>

<success_criteria>
- ProductInput, ProductAnalysis, MasterScript, ArollScene, BrollShot, AdBreakdown, UGCAdResponse schemas defined and importable
- analyze_product() uses LLMProvider.generate_structured() with ProductAnalysis schema
- generate_ugc_script() uses two-call pattern (generate_text + generate_structured) with AdBreakdown schema
- CATEGORY_PROMPTS dict has cosmetics, tech, food, fashion, SaaS, default entries
- All functions work with MockLLMProvider (no API keys needed)
</success_criteria>

<output>
After completion, create `.planning/phases/13-ugc-product-ad-pipeline/13-01-SUMMARY.md`
</output>
