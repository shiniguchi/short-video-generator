---
phase: 11-real-ai-providers
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - app/config.py
  - app/services/voiceover_generator/elevenlabs_tts.py
  - app/services/voiceover_generator/fish_audio_tts.py
  - app/services/voiceover_generator/generator.py
  - app/services/voiceover_generator/__init__.py
  - requirements.txt
autonomous: true
user_setup:
  - service: ElevenLabs
    why: "Premium TTS voiceover generation"
    env_vars:
      - name: ELEVENLABS_API_KEY
        source: "https://elevenlabs.io/app/settings/api-keys — create API key"
    dashboard_config: []
  - service: Fish Audio
    why: "Budget TTS voiceover with competitive quality"
    env_vars:
      - name: FISH_AUDIO_API_KEY
        source: "https://fish.audio/account — get API key from account settings"
    dashboard_config: []

must_haves:
  truths:
    - "Setting TTS_PROVIDER_TYPE=elevenlabs selects ElevenLabs provider"
    - "Setting TTS_PROVIDER_TYPE=fish selects Fish Audio provider"
    - "Both providers generate MP3 audio files from text input"
    - "OpenAI TTS provider still works when TTS_PROVIDER_TYPE=openai"
    - "Mock provider still works when TTS_PROVIDER_TYPE=mock (default)"
    - "Missing API keys gracefully fall back to mock provider"
  artifacts:
    - path: "app/services/voiceover_generator/elevenlabs_tts.py"
      provides: "ElevenLabs TTS voiceover generation"
      contains: "class ElevenLabsTTSProvider"
    - path: "app/services/voiceover_generator/fish_audio_tts.py"
      provides: "Fish Audio TTS voiceover generation"
      contains: "class FishAudioTTSProvider"
    - path: "app/services/voiceover_generator/generator.py"
      provides: "Updated factory with elevenlabs and fish provider selection"
      contains: "ElevenLabsTTSProvider"
    - path: "app/config.py"
      provides: "New settings for ElevenLabs and Fish Audio API keys"
      contains: "elevenlabs_api_key"
  key_links:
    - from: "app/services/voiceover_generator/generator.py"
      to: "app/services/voiceover_generator/elevenlabs_tts.py"
      via: "factory import and instantiation"
      pattern: "ElevenLabsTTSProvider"
    - from: "app/services/voiceover_generator/elevenlabs_tts.py"
      to: "ElevenLabs API"
      via: "HTTP POST to api.elevenlabs.io"
      pattern: "elevenlabs"
    - from: "app/services/voiceover_generator/fish_audio_tts.py"
      to: "Fish Audio API"
      via: "HTTP POST to api.fish.audio"
      pattern: "fish.audio"
---

<objective>
Implement two real TTS providers (ElevenLabs and Fish Audio), extending the existing TTSProvider abstraction to produce natural voiceover audio.

Purpose: Replace mock silent audio with real AI-generated speech. ElevenLabs is the quality leader for marketing voiceover (70+ languages, $99/mo). Fish Audio is the value alternative (50-70% cheaper, competitive quality in blind tests).

Output: Two new TTSProvider implementations + updated factory + config settings
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-real-ai-providers/11-01-SUMMARY.md
@app/services/voiceover_generator/base.py
@app/services/voiceover_generator/mock.py
@app/services/voiceover_generator/openai_tts.py
@app/services/voiceover_generator/generator.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ElevenLabs and Fish Audio TTS providers</name>
  <files>
    app/config.py
    app/services/voiceover_generator/elevenlabs_tts.py
    app/services/voiceover_generator/fish_audio_tts.py
    requirements.txt
  </files>
  <action>
    1. Add to `app/config.py` Settings class (after existing openai_api_key):
       - `elevenlabs_api_key: str = ""` (ELEVENLABS_API_KEY env var)
       - `fish_audio_api_key: str = ""` (FISH_AUDIO_API_KEY env var)

    2. Add `elevenlabs>=1.0.0` to requirements.txt (ElevenLabs Python SDK)
       Note: Fish Audio uses plain httpx (already in requirements.txt) -- no extra SDK needed

    3. Create `app/services/voiceover_generator/elevenlabs_tts.py`:
       - Class `ElevenLabsTTSProvider(TTSProvider)` implementing the base ABC
       - Constructor takes `api_key: str` and `output_dir: str`
       - `generate_speech()` implementation:
         a. If `use_mock_data` is True or `api_key` is empty, delegate to MockTTSProvider (same pattern as OpenAITTSProvider)
         b. Initialize ElevenLabs client: `from elevenlabs.client import ElevenLabs; client = ElevenLabs(api_key=self.api_key)`
         c. Call `client.text_to_speech.convert()` with params:
            - `voice_id`: Map voice name to ID. Default to "Rachel" (21m00Tcm4TlvDq8ikWAM) for marketing. Maintain a dict of common voice name-to-ID mappings.
            - `text`: The input text
            - `model_id`: "eleven_turbo_v2_5" (fast, good quality, cheaper credits)
            - `output_format`: "mp3_44100_128" (44.1kHz MP3 at 128kbps)
         d. Stream response bytes to output file
         e. Return local file path
       - `get_available_voices()`: Return list of preset voice names: ["rachel", "drew", "clyde", "paul", "domi", "bella", "antoni", "elli", "josh", "arnold", "adam", "sam"]
       - Lazy client initialization (same pattern as OpenAITTSProvider)
       - Use `from typing import List, Optional` (Python 3.9 compat)

    4. Create `app/services/voiceover_generator/fish_audio_tts.py`:
       - Class `FishAudioTTSProvider(TTSProvider)` implementing the base ABC
       - Constructor takes `api_key: str` and `output_dir: str`
       - `generate_speech()` implementation:
         a. If `use_mock_data` is True or `api_key` is empty, delegate to MockTTSProvider
         b. Use httpx to POST to `https://api.fish.audio/v1/tts` with:
            - Headers: `Authorization: Bearer {api_key}`, `Content-Type: application/json`
            - JSON body: `{"text": text, "reference_id": voice_id, "format": "mp3"}` where voice_id defaults to a known public voice reference
            - The voice param maps to reference_id. Default voice: use Fish Audio's default English voice
         c. Write response audio bytes to output file
         d. Return local file path
       - `get_available_voices()`: Return list ["default", "english_female", "english_male"] (Fish Audio uses reference_id system, these are convenience aliases)
       - Same mock fallback pattern
       - Use `from typing import List, Optional` (Python 3.9 compat)
       - Use httpx (already in requirements.txt) for HTTP calls -- NOT a Fish Audio SDK

    IMPORTANT: Both providers follow the established mock-fallback pattern from OpenAITTSProvider -- check use_mock_data setting and empty API key before making real API calls.

    IMPORTANT: Python 3.9 compatibility -- use `from typing import List, Optional` not `list[str]`.
  </action>
  <verify>
    - `python -c "from app.services.voiceover_generator.elevenlabs_tts import ElevenLabsTTSProvider; print('ElevenLabs OK')"` succeeds
    - `python -c "from app.services.voiceover_generator.fish_audio_tts import FishAudioTTSProvider; print('Fish OK')"` succeeds
    - Both classes implement TTSProvider ABC (generate_speech, get_available_voices)
    - elevenlabs is in requirements.txt
    - elevenlabs_api_key and fish_audio_api_key settings exist in config.py
  </verify>
  <done>
    ElevenLabsTTSProvider and FishAudioTTSProvider classes exist, import cleanly, implement TTSProvider ABC, have mock fallback when API keys are empty, and elevenlabs dependency is declared
  </done>
</task>

<task type="auto">
  <name>Task 2: Update voiceover generator factory with new provider options</name>
  <files>
    app/services/voiceover_generator/generator.py
    app/services/voiceover_generator/__init__.py
    app/config.py
  </files>
  <action>
    1. Update `get_voiceover_generator()` factory in `app/services/voiceover_generator/generator.py`:
       - Add imports for ElevenLabsTTSProvider and FishAudioTTSProvider
       - Add provider selection branches:
         ```python
         if provider_type == "elevenlabs":
             api_key = getattr(settings, "elevenlabs_api_key", "")
             provider = ElevenLabsTTSProvider(api_key=api_key, output_dir=output_dir)
         elif provider_type == "fish":
             api_key = getattr(settings, "fish_audio_api_key", "")
             provider = FishAudioTTSProvider(api_key=api_key, output_dir=output_dir)
         elif provider_type == "openai":
             api_key = getattr(settings, "openai_api_key", "")
             provider = OpenAITTSProvider(api_key=api_key, output_dir=output_dir)
         else:
             provider = MockTTSProvider(output_dir=output_dir)
         ```
       - Update docstring to reflect new options: mock/openai/elevenlabs/fish

    2. Update `app/services/voiceover_generator/__init__.py` to export new provider classes

    3. Update comment in `app/config.py` for tts_provider_type to include new options:
       `tts_provider_type: str = "mock"  # mock/openai/elevenlabs/fish`
  </action>
  <verify>
    - `python -c "from app.services.voiceover_generator.generator import get_voiceover_generator; print('Factory OK')"` succeeds
    - Factory docstring mentions elevenlabs and fish options
    - __init__.py exports ElevenLabsTTSProvider, FishAudioTTSProvider
  </verify>
  <done>
    Voiceover generator factory selects ElevenLabs when TTS_PROVIDER_TYPE=elevenlabs, Fish Audio when TTS_PROVIDER_TYPE=fish, retains OpenAI when TTS_PROVIDER_TYPE=openai, and still defaults to mock. All imports resolve cleanly.
  </done>
</task>

</tasks>

<verification>
1. All existing provider functionality preserved (mock, OpenAI TTS unchanged)
2. New provider classes implement TTSProvider ABC correctly
3. Factory function selects correct provider based on TTS_PROVIDER_TYPE setting
4. elevenlabs dependency added to requirements.txt
5. Config includes elevenlabs_api_key and fish_audio_api_key settings
6. Python 3.9 compatible (no list[str] syntax, uses typing imports)
</verification>

<success_criteria>
- TTS_PROVIDER_TYPE=elevenlabs instantiates ElevenLabsTTSProvider
- TTS_PROVIDER_TYPE=fish instantiates FishAudioTTSProvider
- TTS_PROVIDER_TYPE=openai still works (existing provider)
- Both new providers fall back to mock when API keys are empty or USE_MOCK_DATA=true
- Mock provider remains default (TTS_PROVIDER_TYPE=mock)
- No import errors in any module
</success_criteria>

<output>
After completion, create `.planning/phases/11-real-ai-providers/11-02-SUMMARY.md`
</output>
