---
phase: 11-real-ai-providers
plan: 03
type: execute
wave: 3
depends_on: ["11-01", "11-02"]
files_modified:
  - app/config.py
  - app/services/avatar_generator/__init__.py
  - app/services/avatar_generator/base.py
  - app/services/avatar_generator/mock.py
  - app/services/avatar_generator/heygen.py
  - app/services/avatar_generator/generator.py
  - app/tasks.py
  - .env.example
autonomous: true
user_setup:
  - service: HeyGen
    why: "AI avatar talking-head video generation for marketing presenters"
    env_vars:
      - name: HEYGEN_API_KEY
        source: "https://app.heygen.com/settings â€” API Access section, generate API key"
    dashboard_config: []

must_haves:
  truths:
    - "Setting AVATAR_PROVIDER_TYPE=heygen selects HeyGen avatar provider"
    - "HeyGen provider generates talking-head video from script text + avatar ID"
    - "Mock avatar provider generates placeholder video when AVATAR_PROVIDER_TYPE=mock"
    - "Pipeline can optionally use avatar provider instead of video generation provider"
    - "All new provider env vars documented in .env.example"
    - "Pipeline runs end-to-end with mock providers (no API keys) without errors"
  artifacts:
    - path: "app/services/avatar_generator/base.py"
      provides: "AvatarProvider ABC defining talking-head generation interface"
      contains: "class AvatarProvider"
    - path: "app/services/avatar_generator/heygen.py"
      provides: "HeyGen avatar video generation via API"
      contains: "class HeyGenAvatarProvider"
    - path: "app/services/avatar_generator/mock.py"
      provides: "Mock avatar provider for local development"
      contains: "class MockAvatarProvider"
    - path: "app/services/avatar_generator/generator.py"
      provides: "Avatar generator service with factory function"
      contains: "get_avatar_generator"
    - path: "app/config.py"
      provides: "Avatar provider settings (heygen_api_key, avatar_provider_type)"
      contains: "avatar_provider_type"
  key_links:
    - from: "app/tasks.py"
      to: "app/services/avatar_generator/generator.py"
      via: "import and call in generate_content_task"
      pattern: "get_avatar_generator"
    - from: "app/services/avatar_generator/heygen.py"
      to: "HeyGen API"
      via: "HTTP POST to api.heygen.com"
      pattern: "heygen"
    - from: "app/config.py"
      to: "app/services/avatar_generator/generator.py"
      via: "avatar_provider_type setting drives factory selection"
      pattern: "avatar_provider_type"
---

<objective>
Implement HeyGen avatar (talking-head) provider as a new subsystem, wire it into the content generation pipeline as an alternative to standard video generation, and update .env.example with all new provider settings.

Purpose: HeyGen Avatar IV generates realistic talking presenter videos from script text -- ideal for TikTok marketing content. The avatar provider is a separate subsystem from video generation because its input is script text (not visual prompts) and it produces a complete talking-head video (not raw clips).

Output: New avatar_generator subsystem (ABC + mock + HeyGen) + pipeline integration + env documentation
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-real-ai-providers/11-01-SUMMARY.md
@.planning/phases/11-real-ai-providers/11-02-SUMMARY.md
@app/services/video_generator/base.py
@app/services/voiceover_generator/openai_tts.py
@app/tasks.py
@app/config.py
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create avatar generator subsystem with HeyGen provider</name>
  <files>
    app/config.py
    app/services/avatar_generator/__init__.py
    app/services/avatar_generator/base.py
    app/services/avatar_generator/mock.py
    app/services/avatar_generator/heygen.py
    app/services/avatar_generator/generator.py
  </files>
  <action>
    1. Add to `app/config.py` Settings class:
       - `heygen_api_key: str = ""` (HEYGEN_API_KEY env var)
       - `avatar_provider_type: str = "mock"  # mock/heygen`
       - `heygen_avatar_id: str = ""` (default avatar ID, user configures from HeyGen dashboard)

    2. Create `app/services/avatar_generator/__init__.py`:
       - Export AvatarProvider, MockAvatarProvider, HeyGenAvatarProvider, AvatarGeneratorService, get_avatar_generator

    3. Create `app/services/avatar_generator/base.py`:
       - Abstract base class `AvatarProvider(ABC)` with methods:
         - `generate_avatar_video(script_text: str, avatar_id: str = "default", voice_id: str = "default") -> str`
           - Takes script text and avatar configuration
           - Returns path to generated MP4 video with talking head
         - `get_available_avatars() -> List[str]`
           - Returns list of available avatar identifiers
       - Use `from typing import List, Optional` (Python 3.9 compat)

    4. Create `app/services/avatar_generator/mock.py`:
       - Class `MockAvatarProvider(AvatarProvider)`
       - `generate_avatar_video()`: Generate a solid-color placeholder MP4 clip (same pattern as MockVideoProvider) with duration based on script text length (~15 chars/sec, same as MockTTSProvider)
       - `get_available_avatars()`: Return ["mock_avatar"]
       - Constructor takes `output_dir: str`
       - Uses moviepy ColorClip to generate 720x1280 placeholder

    5. Create `app/services/avatar_generator/heygen.py`:
       - Class `HeyGenAvatarProvider(AvatarProvider)`
       - Constructor takes `api_key: str`, `output_dir: str`, `default_avatar_id: str = ""`
       - `generate_avatar_video()` implementation:
         a. If `use_mock_data` is True or `api_key` is empty, delegate to MockAvatarProvider
         b. Create video via HeyGen API v2:
            - POST to `https://api.heygen.com/v2/video/generate` with headers `X-Api-Key: {api_key}`
            - JSON body:
              ```json
              {
                "video_inputs": [{
                  "character": {
                    "type": "avatar",
                    "avatar_id": avatar_id,
                    "avatar_style": "normal"
                  },
                  "voice": {
                    "type": "text",
                    "input_text": script_text,
                    "voice_id": voice_id
                  }
                }],
                "dimension": {"width": 720, "height": 1280}
              }
              ```
         c. Poll `GET https://api.heygen.com/v1/video_status.get?video_id={video_id}` until status is "completed"
            - Poll every 10 seconds, timeout after 10 minutes
         d. Download resulting video URL to local file in `output_dir/avatars/`
         e. Return local file path
       - `get_available_avatars()`: Return list of common HeyGen avatar IDs (or fetch from API if key available)
       - Use httpx for HTTP calls
       - Use `from typing import List, Optional` (Python 3.9 compat)

    6. Create `app/services/avatar_generator/generator.py`:
       - Class `AvatarGeneratorService`:
         - Constructor takes `provider: AvatarProvider` and `output_dir: str`
         - Method `generate_avatar_video(script_text: str, avatar_id: str = "default", voice_id: str = "default") -> str`
           - Delegates to provider.generate_avatar_video()
       - Factory function `get_avatar_generator() -> AvatarGeneratorService`:
         - Read `avatar_provider_type` from settings
         - "heygen" -> HeyGenAvatarProvider(api_key, output_dir, default_avatar_id)
         - else -> MockAvatarProvider(output_dir)
  </action>
  <verify>
    - `python -c "from app.services.avatar_generator import AvatarProvider, MockAvatarProvider, HeyGenAvatarProvider, get_avatar_generator; print('Avatar OK')"` succeeds
    - MockAvatarProvider generates placeholder MP4
    - HeyGenAvatarProvider falls back to mock when API key is empty
    - avatar_provider_type and heygen_api_key settings exist in config.py
  </verify>
  <done>
    Avatar generator subsystem exists with ABC, mock, and HeyGen providers. Factory selects provider based on AVATAR_PROVIDER_TYPE setting. HeyGen falls back to mock when API key is empty.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire avatar provider into pipeline and update env documentation</name>
  <files>
    app/tasks.py
    .env.example
  </files>
  <action>
    1. Update `generate_content_task` in `app/tasks.py`:
       - After Step 5 (video generation) and Step 6 (voiceover), add an optional Step 5b for avatar generation:
         ```python
         # Step 5b: Generate avatar video if avatar provider is configured
         from app.config import get_settings
         settings = get_settings()
         if settings.avatar_provider_type != "mock" or not settings.use_mock_data:
             # Check if avatar is preferred over standard video
             if settings.avatar_provider_type in ("heygen",):
                 from app.services.avatar_generator.generator import get_avatar_generator
                 avatar_gen = get_avatar_generator()
                 avatar_path = avatar_gen.generate_avatar_video(
                     script_text=plan['voiceover_script'],
                 )
                 logger.info(f"Avatar video generated: {avatar_path}")
                 # Avatar replaces both video and audio (it includes the presenter speaking)
                 video_path = avatar_path
                 audio_path = avatar_path  # Avatar video has embedded audio
         ```
       - The key insight: When avatar_provider_type is set to "heygen", the avatar video REPLACES the separate video + voiceover because HeyGen produces a complete talking-head video with speech audio embedded. The compositor will then add text overlays on top.
       - When avatar_provider_type is "mock" (default), the pipeline works exactly as before (separate video + voiceover generation).

    2. Update `.env.example` to include ALL new provider settings from Plans 01-03:
       - Add section comments for organization
       - Add: `FAL_KEY=` (for Kling/Minimax video generation via fal.ai)
       - Add: `VIDEO_PROVIDER_TYPE=mock` (mock/svd/kling/minimax)
       - Add: `TTS_PROVIDER_TYPE=mock` (mock/openai/elevenlabs/fish)
       - Add: `ELEVENLABS_API_KEY=` (for ElevenLabs TTS)
       - Add: `FISH_AUDIO_API_KEY=` (for Fish Audio TTS)
       - Add: `AVATAR_PROVIDER_TYPE=mock` (mock/heygen)
       - Add: `HEYGEN_API_KEY=` (for HeyGen avatar generation)
       - Add: `HEYGEN_AVATAR_ID=` (default avatar ID from HeyGen dashboard)
       - Keep existing settings unchanged

    3. Verify the full pipeline still works with all-mock defaults:
       - USE_MOCK_DATA=true (default)
       - VIDEO_PROVIDER_TYPE=mock (default)
       - TTS_PROVIDER_TYPE=mock (default)
       - AVATAR_PROVIDER_TYPE=mock (default)
  </action>
  <verify>
    - `python -c "from app.tasks import generate_content_task; print('Tasks OK')"` succeeds
    - .env.example contains all new env vars (FAL_KEY, VIDEO_PROVIDER_TYPE, TTS_PROVIDER_TYPE, ELEVENLABS_API_KEY, FISH_AUDIO_API_KEY, AVATAR_PROVIDER_TYPE, HEYGEN_API_KEY, HEYGEN_AVATAR_ID)
    - Pipeline imports resolve cleanly with default mock settings
    - No breaking changes to existing pipeline flow
  </verify>
  <done>
    Avatar provider wired into content generation pipeline. When AVATAR_PROVIDER_TYPE=heygen, HeyGen talking-head replaces separate video+voiceover. Default mock flow unchanged. .env.example documents all new provider configuration.
  </done>
</task>

</tasks>

<verification>
1. Avatar generator subsystem follows established provider pattern (ABC + mock + real + factory)
2. HeyGen provider creates talking-head video from script text via API
3. Pipeline conditionally uses avatar when configured
4. All default mock paths work without any API keys
5. .env.example documents all new provider env vars from all 3 plans
6. Python 3.9 compatible throughout
</verification>

<success_criteria>
- AVATAR_PROVIDER_TYPE=heygen instantiates HeyGenAvatarProvider
- HeyGen provider falls back to mock when HEYGEN_API_KEY is empty or USE_MOCK_DATA=true
- Pipeline generates content end-to-end with all-mock defaults
- .env.example contains all provider configuration keys
- No import errors or pipeline breakage with default settings
</success_criteria>

<output>
After completion, create `.planning/phases/11-real-ai-providers/11-03-SUMMARY.md`
</output>
