---
phase: 11-real-ai-providers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/services/video_generator/fal_kling.py
  - app/services/video_generator/fal_minimax.py
  - app/services/video_generator/generator.py
  - requirements.txt
autonomous: true
user_setup:
  - service: fal.ai
    why: "Unified API gateway for Kling and Minimax video generation"
    env_vars:
      - name: FAL_KEY
        source: "https://fal.ai/dashboard/keys â€” create API key"
    dashboard_config: []

must_haves:
  truths:
    - "Setting VIDEO_PROVIDER_TYPE=kling selects Kling 3.0 provider via fal.ai"
    - "Setting VIDEO_PROVIDER_TYPE=minimax selects Minimax/Hailuo provider via fal.ai"
    - "Both providers produce 9:16 vertical MP4 clips from text prompts"
    - "Mock provider still works when VIDEO_PROVIDER_TYPE=mock (default)"
    - "Missing FAL_KEY gracefully falls back to mock provider"
  artifacts:
    - path: "app/services/video_generator/fal_kling.py"
      provides: "Kling 3.0 video generation via fal.ai API"
      contains: "class FalKlingProvider"
    - path: "app/services/video_generator/fal_minimax.py"
      provides: "Minimax/Hailuo video generation via fal.ai API"
      contains: "class FalMinimaxProvider"
    - path: "app/services/video_generator/generator.py"
      provides: "Updated factory with kling and minimax provider selection"
      contains: "FalKlingProvider"
    - path: "app/config.py"
      provides: "New settings for fal.ai API key and video provider options"
      contains: "fal_key"
  key_links:
    - from: "app/services/video_generator/generator.py"
      to: "app/services/video_generator/fal_kling.py"
      via: "factory import and instantiation"
      pattern: "FalKlingProvider"
    - from: "app/services/video_generator/fal_kling.py"
      to: "fal.ai API"
      via: "HTTP POST to fal.ai queue endpoint"
      pattern: "fal_client"
---

<objective>
Implement two real video generation providers (Kling 3.0 and Minimax/Hailuo) via the fal.ai unified API gateway, extending the existing VideoProvider abstraction.

Purpose: Replace mock video with actual AI-generated clips. fal.ai provides a consistent API across multiple video models, reducing integration complexity. Kling is the quality pick ($0.029/sec, 4K), Minimax is the budget pick ($0.02-0.05/video, fast).

Output: Two new VideoProvider implementations + updated factory + config settings
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-generation/03-02-SUMMARY.md
@app/services/video_generator/base.py
@app/services/video_generator/mock.py
@app/services/video_generator/generator.py
@app/services/voiceover_generator/openai_tts.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Kling and Minimax video providers via fal.ai</name>
  <files>
    app/config.py
    app/services/video_generator/fal_kling.py
    app/services/video_generator/fal_minimax.py
    requirements.txt
  </files>
  <action>
    1. Add to `app/config.py` Settings class:
       - `fal_key: str = ""` (FAL_KEY env var for fal.ai API authentication)

    2. Add `fal-client>=0.5.0` to requirements.txt (fal.ai Python SDK)

    3. Create `app/services/video_generator/fal_kling.py`:
       - Class `FalKlingProvider(VideoProvider)` implementing the base ABC
       - Constructor takes `fal_key: str` and `output_dir: str`
       - `generate_clip()` implementation:
         a. Import fal_client. Set `os.environ["FAL_KEY"] = self.fal_key` before API calls
         b. Submit job to fal.ai Kling endpoint (model: `fal-ai/kling-video/v2/master`) using `fal_client.submit()`
         c. Request 9:16 aspect ratio (720x1280 or closest supported). Use params: `prompt`, `duration` (map seconds to "5" or "10" string), `aspect_ratio` ("9:16")
         d. Poll for completion using `result = fal_client.result("fal-ai/kling-video/v2/master", request_id)` or use `subscribe()` for blocking
         e. Download the resulting video URL to local file in `output_dir/clips/` using httpx
         f. Return local file path
       - `supports_resolution()`: return True for 720x1280 and 1080x1920 (9:16 ratios)
       - Graceful fallback: if `fal_key` is empty or `use_mock_data` is True, delegate to MockVideoProvider (same pattern as OpenAITTSProvider)
       - Use `from typing import Optional, List` (Python 3.9 compat)

    4. Create `app/services/video_generator/fal_minimax.py`:
       - Class `FalMinimaxProvider(VideoProvider)` implementing the base ABC
       - Same constructor pattern (fal_key, output_dir)
       - `generate_clip()` implementation:
         a. Submit to fal.ai Minimax endpoint (model: `fal-ai/minimax-video/video-01-live`) using `fal_client.submit()`
         b. Params: `prompt`, `prompt_optimizer` (True for better results)
         c. Poll/subscribe for completion
         d. Download resulting video URL to local file
         e. Return local file path
       - `supports_resolution()`: return True for resolutions up to 1080p
       - Same mock fallback pattern as Kling provider
       - Use `from typing import Optional, List` (Python 3.9 compat)

    IMPORTANT: Both providers must handle fal.ai's async job pattern (submit -> poll -> download). Use `fal_client.subscribe()` for simplicity since Celery tasks are already async. Log generation time and cost estimates.

    IMPORTANT: Python 3.9 compatibility -- use `from typing import List, Optional` not `list[str]`.
  </action>
  <verify>
    - `python -c "from app.services.video_generator.fal_kling import FalKlingProvider; print('Kling OK')"` succeeds
    - `python -c "from app.services.video_generator.fal_minimax import FalMinimaxProvider; print('Minimax OK')"` succeeds
    - Both classes implement VideoProvider ABC (generate_clip, supports_resolution)
    - fal-client is in requirements.txt
    - fal_key setting exists in config.py
  </verify>
  <done>
    FalKlingProvider and FalMinimaxProvider classes exist, import cleanly, implement VideoProvider ABC, have mock fallback when FAL_KEY is empty, and fal-client dependency is declared
  </done>
</task>

<task type="auto">
  <name>Task 2: Update video generator factory with new provider options</name>
  <files>
    app/services/video_generator/generator.py
    app/services/video_generator/__init__.py
  </files>
  <action>
    1. Update `get_video_generator()` factory in `app/services/video_generator/generator.py`:
       - Add imports for FalKlingProvider and FalMinimaxProvider
       - Add provider selection branches:
         ```python
         if provider_type == "kling":
             fal_key = getattr(settings, "fal_key", "")
             provider = FalKlingProvider(fal_key=fal_key, output_dir=output_dir)
         elif provider_type == "minimax":
             fal_key = getattr(settings, "fal_key", "")
             provider = FalMinimaxProvider(fal_key=fal_key, output_dir=output_dir)
         elif provider_type == "svd":
             provider = StableVideoDiffusionProvider()
         else:
             provider = MockVideoProvider(output_dir=output_dir)
         ```
       - Update docstring to reflect new options: mock/svd/kling/minimax

    2. Update `app/services/video_generator/__init__.py` to export new provider classes for clean imports

    3. Update comment in `app/config.py` for video_provider_type to include new options:
       `video_provider_type: str = "mock"  # mock/svd/kling/minimax`
  </action>
  <verify>
    - `python -c "from app.services.video_generator.generator import get_video_generator; print('Factory OK')"` succeeds
    - Factory docstring mentions kling and minimax options
    - __init__.py exports FalKlingProvider, FalMinimaxProvider
  </verify>
  <done>
    Video generator factory selects Kling provider when VIDEO_PROVIDER_TYPE=kling, Minimax when VIDEO_PROVIDER_TYPE=minimax, and still defaults to mock. All imports resolve cleanly.
  </done>
</task>

</tasks>

<verification>
1. All existing provider tests still pass (mock provider unchanged)
2. New provider classes implement VideoProvider ABC correctly
3. Factory function selects correct provider based on VIDEO_PROVIDER_TYPE setting
4. fal-client dependency added to requirements.txt
5. Config includes fal_key setting
6. Python 3.9 compatible (no list[str] syntax, uses typing imports)
</verification>

<success_criteria>
- VIDEO_PROVIDER_TYPE=kling instantiates FalKlingProvider
- VIDEO_PROVIDER_TYPE=minimax instantiates FalMinimaxProvider
- Both providers fall back to mock when FAL_KEY is empty or USE_MOCK_DATA=true
- Mock provider remains default (VIDEO_PROVIDER_TYPE=mock)
- No import errors in any module
</success_criteria>

<output>
After completion, create `.planning/phases/11-real-ai-providers/11-01-SUMMARY.md`
</output>
