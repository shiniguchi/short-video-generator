---
phase: 05-review-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/tasks.py
  - app/api/routes.py
autonomous: true

must_haves:
  truths:
    - "Final videos appear in output/review/ directory after composition completes"
    - "Generation log in Video.extra_data records gen_id, timestamp, theme, trend pattern, prompts, model, cost, path, status"
    - "Per-video cost_usd field is populated with sum of all API call costs"
    - "POST /videos/{id}/approve moves video file from review/ to approved/ and updates status"
    - "POST /videos/{id}/reject moves video file from review/ to rejected/ and updates status"
  artifacts:
    - path: "app/config.py"
      provides: "review_output_dir setting pointing to output/review"
      contains: "review_output_dir"
    - path: "app/tasks.py"
      provides: "compose_video_task saves to output/review, tracks cost, logs generation metadata"
      contains: "review"
    - path: "app/api/routes.py"
      provides: "POST approve and reject endpoints with file move operations"
      contains: "approve"
  key_links:
    - from: "app/tasks.py"
      to: "app/config.py"
      via: "settings.review_output_dir"
      pattern: "review_output_dir"
    - from: "app/api/routes.py"
      to: "app/models.py"
      via: "Video.status update and file_path update"
      pattern: "shutil\\.move"
    - from: "app/tasks.py"
      to: "app/models.py"
      via: "Video.cost_usd and Video.extra_data population"
      pattern: "cost_usd"
---

<objective>
Review workflow with cost tracking: output to review directory, generation logging, per-video cost tracking, and approve/reject API endpoints.

Purpose: Enable human review workflow where generated videos land in output/review/, can be approved (moved to output/approved/) or rejected (moved to output/rejected/), with full generation metadata and cost tracking logged per video.

Output: Updated compose pipeline outputting to review/, approve/reject REST endpoints, per-video cost accumulation, generation metadata logging.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-composition/04-02-SUMMARY.md
@app/config.py
@app/tasks.py
@app/api/routes.py
@app/models.py
@app/schemas.py
@app/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update composition output to review directory with cost tracking and generation logging</name>
  <files>app/config.py, app/tasks.py</files>
  <action>
**app/config.py changes:**
1. Change `composition_output_dir` default from `"output/final"` to `"output/review"` (REVIEW-01)
2. Add `approved_output_dir: str = "output/approved"` setting
3. Add `rejected_output_dir: str = "output/rejected"` setting

**app/tasks.py changes in compose_video_task:**
1. Update VideoCompositor instantiation to use `settings.composition_output_dir` (already does this, just verify it will now point to output/review/)
2. In `_save_video_record`, add cost tracking: accept a `cost_usd` parameter and set `video.cost_usd = cost_usd`
3. In `_save_video_record`, add generation metadata: accept a `generation_metadata` dict parameter and set `video.extra_data = generation_metadata`
4. After composition, calculate total cost estimate and build generation metadata dict

**Cost tracking approach (REVIEW-05):**
Since this is a prototype with mock providers, track costs as follows:
- Accept optional `cost_data` dict parameter in compose_video_task (default empty dict)
- Sum costs from cost_data keys: `claude_cost`, `tts_cost`, `video_gen_cost` (all default 0.0)
- Store total in `video.cost_usd`
- In generate_content_task, build cost_data dict and pass to compose_video_task.delay()
- For mock providers, cost is 0.0. For real providers, costs will be populated when providers are swapped in

**Generation logging approach (REVIEW-02):**
Build a generation_metadata dict in compose_video_task with:
- `gen_id`: uuid4 hex string
- `timestamp`: ISO 8601 UTC timestamp
- `theme`: from script.theme_config (if available, extract "theme" key)
- `trend_pattern`: from script.trend_report_id (store the ID for reference)
- `prompts`: dict with `video_prompt` and `voiceover_script` from script
- `model`: dict with `script_model` ("claude"), `video_model` (settings.video_provider_type), `tts_model` (settings.tts_provider_type)
- `cost_usd`: total cost
- `output_path`: composed video file path
- `status`: "generated"

**Update generate_content_task to pass cost_data:**
1. In generate_content_task, after all generation steps, build cost_data dict: `{"claude_cost": 0.0, "tts_cost": 0.0, "video_gen_cost": 0.0}` (zero for mock, ready for real provider cost reporting)
2. Change `compose_video_task.delay(script_id, video_path, audio_path)` to `compose_video_task.delay(script_id, video_path, audio_path, cost_data=cost_data)`
3. Update compose_video_task signature to accept `cost_data: dict = None`
  </action>
  <verify>
1. `grep -n "output/review" app/config.py` shows the new default
2. `grep -n "output/approved" app/config.py` shows approved dir setting
3. `grep -n "output/rejected" app/config.py` shows rejected dir setting
4. `grep -n "cost_usd" app/tasks.py` shows cost tracking in _save_video_record
5. `grep -n "extra_data" app/tasks.py` shows generation metadata logging
6. `grep -n "cost_data" app/tasks.py` shows cost_data parameter in both tasks
7. `python -c "from app.tasks import compose_video_task, generate_content_task; print('imports OK')"` succeeds
  </verify>
  <done>
- composition_output_dir defaults to "output/review" instead of "output/final"
- approved_output_dir and rejected_output_dir settings exist in config
- compose_video_task saves Video with cost_usd populated from summed cost_data
- compose_video_task saves Video with extra_data containing full generation metadata (gen_id, timestamp, theme, trend_pattern, prompts, model, cost, path, status)
- generate_content_task passes cost_data dict to compose_video_task
  </done>
</task>

<task type="auto">
  <name>Task 2: Add approve and reject REST API endpoints with file move operations</name>
  <files>app/api/routes.py</files>
  <action>
Add two new endpoints in a `# --- Phase 5: Review & Output ---` section after the Phase 4 section:

**POST /videos/{video_id}/approve (REVIEW-03):**
1. Accept `video_id: int` path parameter
2. Inject `session: AsyncSession = Depends(get_session)`
3. Query Video by ID, raise 404 if not found
4. Validate video.status == "generated" (raise 400 if already approved/rejected/published)
5. Import `shutil`, `os`, `Path` from pathlib, and `datetime`
6. Get settings for `approved_output_dir`
7. Ensure output/approved/ directory exists (`Path(settings.approved_output_dir).mkdir(parents=True, exist_ok=True)`)
8. Move video file: `shutil.move(video.file_path, new_path)` where new_path = approved_output_dir / filename
9. Move thumbnail file if exists: same pattern with thumbnail_path
10. Update video record: `video.status = "approved"`, `video.approved_at = datetime.now(timezone.utc)`, `video.file_path = str(new_path)`, update thumbnail_path if moved
11. Also update extra_data status field to "approved" if extra_data exists
12. Commit and return updated video dict
13. Wrap file operations in try/except â€” if file not found, still update DB status but include warning in response

**POST /videos/{video_id}/reject (REVIEW-04):**
1. Same pattern as approve but:
   - Move to `settings.rejected_output_dir` (output/rejected/)
   - Set `video.status = "rejected"`
   - Do NOT set approved_at
   - Update extra_data status to "rejected" if exists
2. Return updated video dict

**Response format for both endpoints:**
```json
{
  "id": video.id,
  "status": "approved|rejected",
  "file_path": "new/path/to/file.mp4",
  "thumbnail_path": "new/path/to/thumb.jpg",
  "cost_usd": video.cost_usd,
  "approved_at": "2026-02-14T...",
  "message": "Video approved and moved to output/approved/"
}
```

Import additions at top of routes.py: `import shutil`, `from pathlib import Path`, `from datetime import datetime, timezone`
  </action>
  <verify>
1. `grep -n "approve" app/api/routes.py` shows approve endpoint
2. `grep -n "reject" app/api/routes.py` shows reject endpoint
3. `grep -n "shutil.move" app/api/routes.py` shows file move operations
4. `python -c "from app.api.routes import router; print([r.path for r in router.routes])"` includes /videos/{video_id}/approve and /videos/{video_id}/reject
5. `python -c "from app.config import get_settings; s = get_settings(); print(s.approved_output_dir, s.rejected_output_dir)"` prints the directories
  </verify>
  <done>
- POST /videos/{video_id}/approve endpoint exists and moves files to output/approved/
- POST /videos/{video_id}/reject endpoint exists and moves files to output/rejected/
- Both endpoints validate video status before operating
- Both endpoints update Video record (status, file_path, thumbnail_path, approved_at)
- Both endpoints update extra_data status field for generation log consistency
- File-not-found errors are handled gracefully (DB still updated with warning)
  </done>
</task>

</tasks>

<verification>
1. Config settings point to correct directories:
   - `composition_output_dir = "output/review"`
   - `approved_output_dir = "output/approved"`
   - `rejected_output_dir = "output/rejected"`
2. compose_video_task creates videos in output/review/ directory
3. Video.cost_usd is populated with cost data
4. Video.extra_data contains full generation metadata
5. POST /videos/{id}/approve moves file and updates status to "approved"
6. POST /videos/{id}/reject moves file and updates status to "rejected"
7. All imports resolve without errors
</verification>

<success_criteria>
- Videos are composed into output/review/ directory (not output/final/)
- Each Video record has cost_usd populated (0.0 for mock providers)
- Each Video record has extra_data with gen_id, timestamp, theme, trend_pattern, prompts, model, cost, path, status
- Approve endpoint moves files from review/ to approved/ and sets status="approved" + approved_at
- Reject endpoint moves files from review/ to rejected/ and sets status="rejected"
- Invalid status transitions (e.g., approving already-rejected video) return 400
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-output/05-01-SUMMARY.md`
</output>
