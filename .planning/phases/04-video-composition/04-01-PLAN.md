---
phase: 04-video-composition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/video_compositor/__init__.py
  - app/services/video_compositor/text_overlay.py
  - app/services/video_compositor/audio_mixer.py
  - app/services/video_compositor/thumbnail.py
  - app/services/video_compositor/compositor.py

autonomous: true

must_haves:
  truths:
    - "VideoCompositor.compose() accepts video_path, audio_path, text_overlays, and optional background_music_path and returns dict with video_path, thumbnail_path, duration"
    - "Text overlays render with Montserrat Bold font, configurable position (top/center/bottom), color, stroke, and fade-in animation"
    - "Audio mixer combines voiceover with optional background music at configurable volume (default 30%)"
    - "Thumbnail generator extracts frame at configurable timestamp and saves as JPEG via Pillow"
    - "Output is 9:16 vertical MP4 encoded with H.264 video and AAC audio"
  artifacts:
    - path: "app/services/video_compositor/compositor.py"
      provides: "Main VideoCompositor orchestrator class"
      contains: "class VideoCompositor"
    - path: "app/services/video_compositor/text_overlay.py"
      provides: "TextClip rendering with position/style mapping"
      contains: "def render_text_overlays"
    - path: "app/services/video_compositor/audio_mixer.py"
      provides: "Voiceover + background music mixing"
      contains: "def mix_audio"
    - path: "app/services/video_compositor/thumbnail.py"
      provides: "Pillow-based frame extraction"
      contains: "def generate_thumbnail"
  key_links:
    - from: "app/services/video_compositor/compositor.py"
      to: "app/services/video_compositor/text_overlay.py"
      via: "import render_text_overlays"
      pattern: "from .text_overlay import render_text_overlays"
    - from: "app/services/video_compositor/compositor.py"
      to: "app/services/video_compositor/audio_mixer.py"
      via: "import mix_audio"
      pattern: "from .audio_mixer import mix_audio"
    - from: "app/services/video_compositor/compositor.py"
      to: "app/services/video_compositor/thumbnail.py"
      via: "import generate_thumbnail"
      pattern: "from .thumbnail import generate_thumbnail"
    - from: "app/services/video_compositor/text_overlay.py"
      to: "app/schemas.py"
      via: "import TextOverlaySchema"
      pattern: "from app.schemas import TextOverlaySchema"
---

<objective>
Build the VideoCompositor service with text overlay rendering, audio mixing, and thumbnail generation modules.

Purpose: This is the core composition engine that combines Phase 3 outputs (raw video + voiceover audio) with text overlays and optional background music into publish-ready MP4 files. Satisfies COMP-01 through COMP-05.

Output: `app/services/video_compositor/` package with compositor orchestrator, text_overlay, audio_mixer, and thumbnail modules.
</objective>

<execution_context>
@/Users/naokitsk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naokitsk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-composition/04-RESEARCH.md
@.planning/phases/03-content-generation/03-02-SUMMARY.md
@.planning/phases/03-content-generation/03-03-SUMMARY.md

@app/schemas.py — TextOverlaySchema (text, timestamp_start, timestamp_end, position, style)
@app/config.py — Settings class with output_dir
@app/models.py — Video model with file_path, thumbnail_path, duration_seconds fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create text_overlay, audio_mixer, and thumbnail modules</name>
  <files>
    app/services/video_compositor/__init__.py
    app/services/video_compositor/text_overlay.py
    app/services/video_compositor/audio_mixer.py
    app/services/video_compositor/thumbnail.py
  </files>
  <action>
Create the `app/services/video_compositor/` package with three utility modules:

**__init__.py:**
Export VideoCompositor from compositor module (import will work after Task 2 creates it).

**text_overlay.py — `render_text_overlays()`:**
- Accept `List[TextOverlaySchema]`, `video_size: Tuple[int, int] = (720, 1280)`, `duration: float = None`
- Return `List[TextClip]` with timing and positioning applied
- Position mapping for 9:16 (720x1280): top=("center", 100), center=("center", "center"), bottom=("center", 1100)
- Font mapping: bold="Montserrat-Bold", normal="Montserrat-Regular", highlight="Montserrat-ExtraBold"
- Default font_size=48, color="white", stroke_color="black", stroke_width=2
- Use method="caption" with size=(video_size[0] - 80, None) for 40px margin each side
- Add margin=(10, 10) to prevent stroke clipping (known MoviePy bug per research)
- Apply timing: `.with_start(overlay.timestamp_start)`, `.with_duration(end - start)`
- Apply position: `.with_position(pos)`
- Apply fade-in animation: `.crossfadein(0.3)`
- Use MoviePy v2.x API (with_start, with_duration, with_position — NOT set_start, set_duration)
- Import from `moviepy` (v2.x): `from moviepy import TextClip`

**audio_mixer.py — `mix_audio()`:**
- Accept `voiceover: AudioFileClip`, `background_music_path: Optional[str]`, `music_volume: float = 0.3`, `duration: float = None`
- If no background_music_path, return voiceover unchanged
- Load background music as AudioFileClip
- Loop music if shorter than duration (use `audio_loop(duration=duration)`)
- Crop music if longer than duration (use `subclipped(0, duration)`)
- Reduce music volume: `.with_multiply_volume(music_volume)` (NOT volumex — deprecated in v2.x)
- Return `CompositeAudioClip([voiceover, music])` — voiceover dominant
- Use context manager for background music file, but return CompositeAudioClip (caller manages lifecycle)

**thumbnail.py — `generate_thumbnail()`:**
- Accept `video_path: str`, `timestamp: float = 2.0`, `output_dir: Optional[str] = None`, `quality: int = 85`
- Use VideoFileClip to extract frame at timestamp with `clip.get_frame(timestamp)`
- Convert numpy array to PIL Image with `Image.fromarray(frame)`
- Save as JPEG to `{output_dir}/{stem}_thumb.jpg` (default output_dir = video_path parent / "thumbnails")
- Create output directory if needed
- Use context manager for VideoFileClip
- Return path string to saved thumbnail
  </action>
  <verify>
Run: `python -c "from app.services.video_compositor.text_overlay import render_text_overlays; from app.services.video_compositor.audio_mixer import mix_audio; from app.services.video_compositor.thumbnail import generate_thumbnail; print('All modules import OK')"` — should print success message without errors.
  </verify>
  <done>Three utility modules exist with correct function signatures, use MoviePy v2.x API, and import without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create VideoCompositor orchestrator class</name>
  <files>
    app/services/video_compositor/compositor.py
    app/services/video_compositor/__init__.py
  </files>
  <action>
Create the main VideoCompositor class that orchestrates all composition modules:

**compositor.py — class VideoCompositor:**
- Constructor: `__init__(self, output_dir: str = "output/final")` — creates output_dir with `Path.mkdir(parents=True, exist_ok=True)`
- Main method: `compose(self, video_path, audio_path, text_overlays, background_music_path=None, music_volume=0.3, output_filename=None, thumbnail_timestamp=2.0) -> dict`
- Use context managers for VideoFileClip and AudioFileClip to ensure cleanup
- Composition flow:
  1. Load base video with `VideoFileClip(video_path)` as context manager
  2. Load voiceover with `AudioFileClip(audio_path)` as context manager
  3. Call `mix_audio(voiceover, background_music_path, music_volume, duration=base_video.duration)` for audio
  4. Call `render_text_overlays(text_overlays, video_size=(720, 1280), duration=base_video.duration)` for text
  5. Create `CompositeVideoClip([base_video] + text_clips, size=(720, 1280))`
  6. Set audio on composite: use `.with_audio(final_audio)` (v2.x API, NOT set_audio)
  7. Assert `final_video.audio is not None` (catch CompositeVideoClip audio drop bug)
  8. Generate output filename: `video_{uuid4().hex[:8]}.mp4` if not provided
  9. Write with `write_videofile(str(output_path), codec="libx264", audio_codec="aac", fps=30, preset="medium", bitrate="5M", audio_bitrate="128k")`
  10. Call `generate_thumbnail(str(output_path), timestamp=thumbnail_timestamp, output_dir=str(self.output_dir.parent / "thumbnails"))`
  11. Explicit cleanup: close final_audio, final_video, and all text_clips
  12. Return `{"video_path": str(output_path), "thumbnail_path": thumbnail_path, "duration": base_video.duration}`

- Import TextOverlaySchema from app.schemas for type hint
- Import uuid4 from uuid for filename generation
- Import Path from pathlib
- Import logging and log key steps (composition start, audio mixed, text overlays rendered, encoding start, thumbnail generated, cleanup)

**Update __init__.py:**
- Export: `from .compositor import VideoCompositor`

Key MoviePy v2.x API notes per research:
- Use `with_audio()` not `set_audio()` (immutable API)
- Use `with_start()`, `with_duration()`, `with_position()` not set_* methods
- Use `with_multiply_volume()` not `volumex()`
- Use `subclipped()` not `subclip()` (renamed in v2.x)
  </action>
  <verify>
Run: `python -c "from app.services.video_compositor import VideoCompositor; vc = VideoCompositor(); print(f'VideoCompositor initialized, output_dir={vc.output_dir}')"` — should print initialization message showing output_dir path.
  </verify>
  <done>VideoCompositor class exists, imports all three utility modules, uses context managers for resource cleanup, writes H.264/AAC MP4 at 9:16, and generates thumbnail.</done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.video_compositor import VideoCompositor"` — imports without error
2. `python -c "from app.services.video_compositor.text_overlay import render_text_overlays, POSITION_MAP, FONT_MAP; print(POSITION_MAP); print(FONT_MAP)"` — shows position and font mappings
3. `python -c "from app.services.video_compositor.audio_mixer import mix_audio; print('audio_mixer OK')"` — imports without error
4. `python -c "from app.services.video_compositor.thumbnail import generate_thumbnail; print('thumbnail OK')"` — imports without error
5. Verify VideoCompositor.compose() method signature accepts all required parameters (video_path, audio_path, text_overlays, background_music_path, music_volume, output_filename, thumbnail_timestamp)
</verification>

<success_criteria>
- VideoCompositor package created with 5 files (init, compositor, text_overlay, audio_mixer, thumbnail)
- All modules import successfully
- VideoCompositor.compose() method returns {video_path, thumbnail_path, duration}
- Text overlay module supports Montserrat Bold font with top/center/bottom positioning
- Audio mixer supports optional background music at configurable volume
- Thumbnail generator uses Pillow for JPEG extraction
- H.264 + AAC encoding configured with 5Mbps bitrate
- All clips use context managers or explicit .close() for memory management
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-composition/04-01-SUMMARY.md`
</output>
